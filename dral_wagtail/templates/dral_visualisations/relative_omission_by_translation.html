{% extends "dral_wagtail/visualisation_page.html" %}

{% block visualisation %}
    <canvas width="2000" height="1000">
        
    </canvas>
{% endblock %}

{% block footer_scripts %}
    {{ block.super }}
    
    <script>
    
    $(function() {
        /*
        Returns the height $element should have to fill the remaining
        space in the viewport.
        If noscrollbar =  1, returns height so that the whole page is
        contained within the viewport. i.e. no scrollbar
        */
        function get_elastic_height($element, min, margin, noscrollbar) {
            var height = 0;
        
            // This is a hack for OL - we force 100% height when it is in
            // full screen mode. See zoom view of images on the faceted search.
            if ($element.find('.ol-full-screen-true').length > 0) {
                return '100%';
            }
        
            min = min || 0;
            margin = margin || 0;
            noscrollbar = noscrollbar || 0;
        
            var current_height = $element.outerHeight();
            if (noscrollbar) {
                // ! only works if body height is NOT 100% !
                height = $(window).outerHeight() - $('body').outerHeight() + current_height;
                height = (height <= min) ? min : height;
            } else {
                var window_height = $(window).height() - margin;
                height = window_height - $element.offset().top + $(document).scrollTop();
                height = (height <= min) ? min : height;
                height = (height > window_height) ? window_height : height;
            }
        
            return Math.floor(height);
        };
    
        /*
        Make $target height elastic. It will take the rest of the
        viewport space. This is automatically updated when the user
        scrolls or change the viewport size.
        $callback is called each time the height is updated.
        */
        function elastic_element($target, callback, min, margin) {
            var on_resize = function(e) {
                var height = get_elastic_height($target, min, margin);
                $target.css('height', height);
                callback();
            };
            $(window).on('resize scroll', function(e) {on_resize(e);});
            $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(e) {on_resize(e);});
            on_resize();
        };
        
        elastic_element($('#visualisation canvas'), draw, 100, 15);
        
        window.vis_data = {{vis_data|safe}};
        
        function draw() {
            var $canvas = $('#visualisation canvas');
            var ctx = $canvas[0].getContext("2d");
            var w = $canvas.prop('width');
            var h = $canvas.prop('height');
            
            ctx.fillStyle = "#FFFFFF";
            ctx.clearRect(0,0,w,h);
            
            graphs_count = 3;
            graph_height = 1.0 * h / graphs_count;
            
            var graph_i = 0;
            
            ctx.font="30px Georgia";
            
            $.each(window.vis_data, function(lang, rows) {
                var y = graph_height * (graph_i + 1);
                ctx.fillStyle = "#404040";
                ctx.fillText(lang, 10, y - graph_height + 30);
                $.each(rows, function(i, row) {
                    var bar_size = row.ratio_omitted * graph_height;
                    var x = Math.round((1.0 * i / rows.length) * w);
                    ctx.fillRect(x, y, 1, -bar_size);
                });
                graph_i += 1;
            });
        }
        
        draw();
    });
    </script>
{% endblock %}

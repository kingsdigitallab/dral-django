{% load dral_wagtail_tags %}

{% verbatim %}
  <div class="svg-viz">
  </div>

  <div class="template viz-calendar">
      <h3>{{language}}</h3>
      <svg class="calendar {{language}}" data-language="{{language}}">
        <g></g>
        <!--   rect class="overlay" width="100%" height="100%"></rect -->
      </svg>
  </div>
{% endverbatim %}

<script>
    $(function() {
        
        window.vis_data = {{ vis_data|json }};
        // console.log(vis_data);

        $viz = $('.svg-viz');

        $.each(window.vis_data, function(lang, data) {
            // console.log(this);
            $viz.append(apply_template(
                'viz-calendar',
                {'language': lang}
            ));
            var $svg_group = $viz.find('g:last');
            var $svg = $svg_group.parent();

            var width = 0;

            // console.log(this.length);

            var width_increment = 20;

            var y = 0;
            var counter = 0;

            $.each(data, function(i, d) {
                var height = d.ratio_omitted * 100;
                
                var class_omitted = (d.ratio_omitted == 1) ? 'omitted' : '';
                if (d.ratio_omitted > 1) class_omitted = 'error';

                var rectangles = d3.select($svg_group[0])
                  .append('rect')
                  .attr('class', 'square ' + class_omitted)
                  .attr('height', '20px')
                  .attr('width', '20px')
                  .attr('x', width)
                  .attr('y', y)
                  .attr('data-idx', i)
                  .attr('data-lng', d.language)
                  // To display aligned at the bottom:
                  // .attr('y', 500 - height)
                  .attr('fill-opacity', d.ratio_omitted)
                  .text(''+ d.lemma+': ' + d.omitted + '/' + d.freq);

                  width += width_increment;
                  counter++;

                if (width+width_increment > $svg.width()) {
                  y += 20;
                  counter = 0;
                  width = 0;
                }
            });
           
           
           $svg.height(y);
        });
        
        // mouseover 
        // TODO: review performances...
        // We don't attach an event to every bar:
        // a) that would be prohibitive
        // b) user couldn't select lemma without omissions (0-height bar)
        // See https://bl.ocks.org/mbostock/3902569
        d3.selectAll('rect').on('mouseenter', function() {
            // TODO: better way to get the index from mouse coord
            var square = d3.select(this)
            infobox_dict(window.vis_data[square.attr('data-lng')][square.attr('data-idx')]);
        }).on('mouseout',
            function() {
                infobox();
            }
        );
    });
</script>
